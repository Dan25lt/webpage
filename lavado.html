<!DOCTYPE html>

<head>
  <title>Altamotriz</title>
  <link rel="shortcut icon" type="image/x-icon" href="./img/car-service.ico" />
  <link rel="stylesheet" href="./css/mi_hoja_de_estilos.css" type="text/css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="./css/asesor.css" type="text/css" />
</head>


<body style="background-color: #F0F0F0 ;">
    
  <div style="background-color: black;">
    <img src="./img/logo.png" width="1300" height="150" alt="" ;>
</div>
  <nav>
    <!--------------------------------- Menu ------------------------------------->
    <div class="li_menu">
      <ul style="border-radius: 8px;">
          <li> <div class="dropdown">
              <button class="dropbtn" onclick="dropdownclickadmin()">Administrador
              <i class="fa fa-caret-down"></i>
              </button>
              <div class="dropdown-content" id="menuadministrador">
                  <a href="./admin_usuarios.html">Aministrar Usuarios</a>
                  <a href="./admin_vehiculos.html">Aministrar Vehiculos</a>
                  <a href="./admin_clientes.html">Aministrar Clientes</a>
              </div>
              </div> 
          </li>
          <li><a href="./gerente.html">Gerente</a></li>
          <li> <div class="dropdown">
            <button class="dropbtn" onclick="dropdownclickasesor()">Asesor
            <i class="fa fa-caret-down"></i>
            </button>
            <div class="dropdown-content" id="menuasesor">
              <a href="./asesor.html">Ver ordenes activas</a>
                <a href="./asesor_nueva_orden_servicio.html">Nueva orden de servicio</a> 
            </div>
            </div> 
        </li>
          <li><a href="./tecnico.html">Tecnico</a></li>
          <li><a href="./lavado.html">Lavador</a></li>
          <li><a href="./calidad.html">Calidad</a></li>
          <li><a href="./logout.php"><img src="./img/cerrar_sesion.ico" alt="Salir" style="width: 25px;height:22px;"></a>
          </li>
      </ul>
  </div>
  </nav>

  <div class="welcome">
    Bienvenido <span id="username"> nombre de usuario </span>
  </div>

  <div style="background-color:#222 ; display: block; height: 22px;
            min-width: 950px; color: white; margin-bottom:5px; padding-top:
            5px;">
    Tabla de Ordenes de Servicio activas
  </div>
  <div class="contenido">
    <div class="fila">
      <div id="tabla_asesor"></div>
    </div>

    <div id="orden_servicio_contenido" orden_actual="0">


      <!-------------------------------------------- Informacion de Orden Seleccionada ------------------------------------------------->
      <div style="background-color:#222 ; display: block; height: 22px;
                min-width: 950px; color: white; margin-bottom:5px; padding-top:
                5px;">
        Informacion de Orden Seleccionada
      </div>
      <div class="fila">
        <table border="0" cellpadding="0" cellspacing="0" width="100%">
          <tr class="info_box">
            <td style="text-align: left; width: 20%;">
              <fieldset style="background-color: #fff;">
                <legend style="font-size: 120%; margin-bottom: 30px;"><strong>Orden:</strong></legend>
                <ul style="background-color:#F2F2F2 ;">
                  <li>Folio: <strong><span id="order_info_folio"></span></strong></li><br>
                  <li>Vehiculo: <strong><span id="order_info_vehiculo"></span></strong></li><br>
                  <li>Placas: <strong><span id="order_info_placas"></span></strong></li><br>
                  <li style="margin-bottom: 20px;">Vin: <strong><span id="order_info_vin"></span></strong></li><br>
                </ul>
              </fieldset>
            </td>
            <td style="text-align: left; width: 20%;">
              <fieldset style="background-color: #fff;">
                <legend style="font-size: 120%; margin-bottom: 30px"><strong>Cliente:</strong></legend>
                <ul style="background-color:#F2F2F2 ;">
                  <li>Nombre: <strong><span id="cliente_nombre"></span></strong></li><br>
                  <li>Telefono: <strong><span id="cliente_telefono"></span></strong></li><br>
                  <li style="margin-bottom: 20px;">RFC: <strong><span id="cliente_rfc"></span></strong></li><br>
                </ul>
              </fieldset>
            </td>
            <td style="text-align: center; width: 20%;">
              <form onsubmit="guardarComentariosAsesor()">
                <legend style="text-align: left; "><strong style="font-size:120% ;">Notas</strong>:</legend>
                <textarea id="comentarios_asesor" rows="6" cols="55" style="border-radius: 5px;" readonly></textarea>
                <!-- <button type="submit" class="button ">Guardar cambios</button> -->
              </form>
            </td>
            <td style="text-align: center; width: 20%;">
              <fieldset style="background-color: rgb(255, 255, 255); text-align: left; float: initial;">
                <legend style="text-align: left; font-size: 120%;"><strong>Operaciones</strong>:</legend>
                <span id="operaciones"></span>
              </fieldset>
            </td>
            <td style="text-align: center; width: 20%;">
                <form onsubmit="guardarEstatus()">
                    <div>
                      <label for="cars">Cambiar el Estatus:</label>
                    </div>
                    <div>
                      <button type="submit" class="btnsindex">Siguiente Area</button>
                    </div>
                  </form>
            </td>
          </tr>

        </table>
      </div>

      <div>
        <table>
          <div id="table-titles">
          </div>
          <div id="table-body">
          </div>
        </table>
      </div>

      <div style="background-color:#222 ; display: block; height: 22px;
        min-width: 950px; color: white; margin-bottom:5px; padding-top: 5px;">
        Fotos
      </div>

      <!-- 
        FOTOS
       -->
      <div id="id01" class="modal">
        <div class="modal-content animate">
          <form class="" onsubmit="validateCaptcha()" id="loginForm">
            <div class="imgcontainer">
              <span onclick="document.getElementById('id01').style.display='none'" class="close"
                title="Close Modal">&times;</span>
            </div>

            <div class="container">
              <div>
                <img src="" id="modal_img" width="450px" height="auto">
              </div>
            </div>

            <div class="container" style="background-color:#f1f1f1">
              <button type="button" onclick="document.getElementById('id01').style.display='none'"
                class="cancelbtn">Cancelar</button>
            </div>
          </form>
        </div>
      </div>

      <table>
        <tr>
          <td><img src="./img/default-image_500.png" class="evidencia" id="img1" width="150px" height="auto"></td>
          <td><img src="./img/default-image_500.png" class="evidencia" id="img2" width="150px" height="auto"></td>
          <td><img src="./img/default-image_500.png" class="evidencia" id="img3" width="150px" height="auto"></td>
          <td><img src="./img/default-image_500.png" class="evidencia" id="img4" width="150px" height="auto"></td>
        </tr>
        <tr>
          <td>
            <!-- esto esta oculto pero es dode se guarda esa imagen hasta hacer el submit -->
            <input type="file" name="file" id="img_to_upload_1" style="opacity: 0; position: absolute; z-index: -1;">
            <!-- con este boton triggerea el updaload -->
            <input type="button" id="btn_uploadfile" value="Cargar" onclick="uploadFile();" >
            <!-- Para borrar -->
            <button id="btn_delete_img1" name="delete_1" class="btnImg">Borrar</button>
            <!-- este es la parte donde se da click -->
            <label for="img_to_upload_1" style="cursor: pointer;">
              <small>seleccionar imagen</small> 
            </label>
          </td>
          <td>
            <!-- esto esta oculto pero es dode se guarda esa imagen hasta hacer el submit -->
            <input type="file" name="file" id="img_to_upload_2" style="opacity: 0; position: absolute; z-index: -1;">
            <!-- con este boton triggerea el updaload -->
            <input type="button" id="btn_uploadfile" value="Cargar" onclick="uploadFile2();" >
            <!-- Para borrar -->
            <button id="btn_delete_img2" name="delete_2" class="btnImg">Borrar</button>
            <!-- este es la parte donde se da click -->
            <label for="img_to_upload_2" style="cursor: pointer;">
              <small>seleccionar imagen</small> 
            </label>
          </td>
          <td>
            <!-- esto esta oculto pero es dode se guarda esa imagen hasta hacer el submit -->
            <input type="file" name="file" id="img_to_upload_3" style="opacity: 0; position: absolute; z-index: -1;">
            <!-- con este boton triggerea el updaload -->
            <input type="button" id="btn_uploadfile" value="Cargar" onclick="uploadFile3();" >
            <!-- Para borrar -->
            <button id="btn_delete_img3" name="delete_3" class="btnImg">Borrar</button>
            <!-- este es la parte donde se da click -->
            <label for="img_to_upload_3" style="cursor: pointer;">
              <small>seleccionar imagen</small> 
            </label>
          </td>
          <td>
            <!-- esto esta oculto pero es dode se guarda esa imagen hasta hacer el submit -->
            <input type="file" name="file" id="img_to_upload_4" style="opacity: 0; position: absolute; z-index: -1;">
            <!-- con este boton triggerea el updaload -->
            <input type="button" id="btn_uploadfile" value="Cargar" onclick="uploadFile4();" >
            <!-- Para borrar -->
            <button id="btn_delete_img4" name="delete_4" class="btnImg">Borrar</button>
            <!-- este es la parte donde se da click -->
            <label for="img_to_upload_4" style="cursor: pointer;">
              <small>seleccionar imagen</small> 
            </label>
          </td>
        </tr>

      </table>

      <div style="background-color:#222 ; display: block; height: 22px;
        min-width: 950px; color: white; margin-bottom:5px; padding-top: 5px;">
        Resumen
      </div>
      <!-------------------------------------------- Resumen ------------------------------------------------->

      <!---------------------- Comentarios  ---------------------->

      <div>
        <table cellpadding="0" cellspacing="0" width="49%" align="left"
          style="margin-top: 10px; border-color: #CCE3F6;">
          <tbody>
            <tr>
              <td>
                <form onsubmit="guardarComentariosLavado()">
                  <legend>Comentarios del area de lavado</legend>
                  <textarea id="comentarios_lavado" rows="8" cols="95"
                    style="border-radius: 5px; margin: 5px; width: 98%;"></textarea>
                  <button type="submit" class="btnsindex">Guardar cambios</button>
                </form>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <br>
      <br>
      <br>
      <br>
      <br>
      <br>

    </div>
  </div>


  <script src="./js/cookies_handler.js"></script>
  <script src="./js/comentarios_lavador.js"></script>
  <script src="./js/modal_imgs.js"></script>

  <!---------------------- Script para la lectura de los datos de la base de datos ---------------------->
  <script>

    function cargarOrdenes() {
      fetch('./backend/getOrdersParaLavado.php', {
        method: 'POST',
        body: {
          info: ''
        }
      })
        .then(function (response) {
          return response.text();
        })
        .then(function (return_data) {
          // console.log(return_data);

          if (return_data == "no hay ordenes de servicio") {
            console.log("TODO: implementa algo");
            return;
          }

          document.getElementById("tabla_asesor").innerHTML = "";

          var data = JSON.parse(return_data);

          var columnNames = ["idordenDeServicio",
            "vin",
            "modelo",
            "placas",
            "fechaEntrada",
            "fechaSalida",
            "estatus",
            // "alertas",
            "opciones"];

          var table = document.createElement('table');

          var tr = document.createElement('tr');
          var td = document.createElement('td');
          var text = document.createTextNode('Orden De Servicio');
          td.appendChild(text);
          tr.appendChild(td);
                    td.style.cssText=" background-color: #222;  color: whitesmoke; padding: 15px;   font-size: 120%; text-align: center;";
          td = document.createElement('td');
          text = document.createTextNode('Vin');
          td.appendChild(text);
          tr.appendChild(td);
                    td.style.cssText=" background-color: #222;  color: whitesmoke; padding: 15px;   font-size: 120%; text-align: center;";
          td = document.createElement('td');
          text = document.createTextNode('Tipo de vehiculo');
          td.appendChild(text);
          tr.appendChild(td);
                    td.style.cssText=" background-color: #222;  color: whitesmoke; padding: 15px;   font-size: 120%; text-align: center;";
          td = document.createElement('td');
          text = document.createTextNode('Placas');
          td.appendChild(text);
          tr.appendChild(td);
                    td.style.cssText=" background-color: #222;  color: whitesmoke; padding: 15px;   font-size: 120%; text-align: center;";
          td = document.createElement('td');
          text = document.createTextNode('Fecha entrada');
          td.appendChild(text);
          tr.appendChild(td);
                    td.style.cssText=" background-color: #222;  color: whitesmoke; padding: 15px;   font-size: 120%; text-align: center;";
          td = document.createElement('td');
          text = document.createTextNode('Fecha salida');
          td.appendChild(text);
          tr.appendChild(td);
                    td.style.cssText=" background-color: #222;  color: whitesmoke; padding: 15px;   font-size: 120%; text-align: center;";
          /* td = document.createElement('td');
          text = document.createTextNode('Estatus');
          td.appendChild(text);
          tr.appendChild(td);
                    td.style.cssText=" background-color: #222;  color: whitesmoke; padding: 15px;   font-size: 120%; text-align: center;"; */
          td = document.createElement('td');
          text = document.createTextNode('Atencion');
          td.appendChild(text);
          tr.appendChild(td);
                    td.style.cssText=" background-color: #222;  color: whitesmoke; padding: 15px;   font-size: 120%; text-align: center;";
          td = document.createElement('td');
          text = document.createTextNode('Opciones');
          td.appendChild(text);
          tr.appendChild(td);
                    td.style.cssText=" background-color: #222;  color: whitesmoke; padding: 15px;   font-size: 120%; text-align: center;";

          table.appendChild(tr);


          for (var i = 0; i < data.length; i++) {
            var tr = document.createElement('tr');
            tr.style.cssText=" background-color: #E7E9EB; padding: 10px; text-align: center;";
            for (var j = 0; j < columnNames.length; j++) {
              var td = document.createElement('td');
              td.style.cssText=" background-color: #E7E9EB; padding: 10px; text-align: center;";
              if (columnNames[j] === 'opciones') {
                var btn = document.createElement('input');
                btn.style.cssText="border:#fff 1px;color: white; display: block;background-color: royalblue;padding: 10px;border-radius: 7px;text-align: center;  margin-right: 10px; ";
                btn.type = "button";
                btn.className = "";

                /*
                * Detalles de cada orden, la guardamos en el boton para no tener que hacer otro GET
                */
                btn.setAttribute("order_id", data[i]['idordenDeServicio']);
                btn.setAttribute("vehiculo", data[i]['modelo'] + " " + data[i]['ano']);
                btn.setAttribute("placas", data[i]['placas']);
                btn.setAttribute("vin", data[i]['vin']);
                btn.setAttribute("nombre_cliente", data[i]['nombre'] + " " + data[i]['apellido']);
                btn.setAttribute("telefono", data[i]['telefono'] || "NA");
                btn.setAttribute("rfc", data[i]['rfc'] || "NA");
                btn.setAttribute("estatus", data[i]['estatus'] || "NA");

                btn.setAttribute("img_url1", data[i]['img_url1'] || "NA");
                btn.setAttribute("img_url2", data[i]['img_url2'] || "NA");
                btn.setAttribute("img_url3", data[i]['img_url3'] || "NA");
                btn.setAttribute("img_url4", data[i]['img_url4'] || "NA");

                btn.value = "     Ver     ";
                var text = btn; // text va a tener adentro un boton

                btn.addEventListener('click', mostrarOrdenServicioEspecifica, false);

              } else {
                var text = document.createTextNode(data[i][columnNames[j]]);
              }
              td.appendChild(text);
              tr.appendChild(td);
            }
            table.appendChild(tr);
          }
          document.getElementById("tabla_asesor").appendChild(table);

        })
        .catch(function (err) {
          console.log(err);
        });
    }

    /*
    * Revisa las cookies y se encarga del login de usuarios
    */
    function inspeccionarMisCookies() {
      var loguedIn = getCookie('loguedIn');
      var username = getCookie('username');
      var puesto = getCookie('puesto');

      document.getElementById("username").innerHTML = username;

      if (!loguedIn) {
        location.replace("/"); // redirecciona al login si el usuario no esta autenticado.
      }

      if (puesto == 'OTRO Puesto') {
        location.replace("/"); // redirecciona a la pagina del puesto para que no ande de metiche aqui
      }

      console.log(`Usuario: Id->${loguedIn}, username: ${username}, puesto: ${puesto}`);
    }

    /*
    * Todo lo referente a la UI
    * Se mete todo en una sola funcion y se corre
    */
    function userInterfaseInit() {
      // Oculata todo el menu hasta que seleccionemos una orden de servicio que ver.
      document.getElementById('orden_servicio_contenido').style.display = 'none';
    }

    var mostrarOrdenServicioEspecifica = function () {
      var orden_id = this.getAttribute("order_id");
      document.getElementById('orden_servicio_contenido').style.display = 'block';

      document.getElementById('orden_servicio_contenido').setAttribute("orden_actual", orden_id);

      getComentariosAsesor(orden_id);
      getComentariosLavado(orden_id);
      /*
      * Mostrar datos de la orden
      */
      document.getElementById("order_info_folio").innerHTML = this.getAttribute("order_id");
      document.getElementById("order_info_vehiculo").innerHTML = this.getAttribute("vehiculo");
      document.getElementById("order_info_placas").innerHTML = this.getAttribute("placas");
      document.getElementById("order_info_vin").innerHTML = this.getAttribute("vin");

      document.getElementById("cliente_nombre").innerHTML = this.getAttribute("nombre_cliente");
      document.getElementById("cliente_telefono").innerHTML = this.getAttribute("telefono");
      document.getElementById("cliente_rfc").innerHTML = this.getAttribute("rfc");

      mostrarImagenesChiquitas(this);

      getOperacionesList(orden_id);
    };

    function getOperacionesList(orden_id) {
      fetch('./backend/getOperaciones.php', {
        method: 'POST',
        body: JSON.stringify({ orden_id: orden_id })
      })
        .then(function (response) {
          return response.text();
        })
        .then(function (return_data) {

          // console.log(return_data);

          if (return_data === "la orden de servicio no tiene operaciones") {
            alert("la orden de servicio no tiene operaciones");
            return;
          }

          document.getElementById('operaciones').innerHTML = "";

          let data = JSON.parse(return_data);
          var div = document.createElement('div');

          for (let i = 0; i < data.length; i++) {
            const operacion = data[i];
            var span = document.createElement('span');
            var text = document.createTextNode("-" + operacion['descripcion']);
            span.appendChild(text);
            div.appendChild(span);
            var br = document.createElement('br');
            div.appendChild(br);
          }
          div.setAttribute("style", "background-color:#F2F2F2 ;");
          document.getElementById('operaciones').appendChild(div);

        })
        .catch(function (err) {
          console.log(err);
        });
    }

    function guardarEstatus() {
      event.preventDefault(); // Previene el evento submit (el que recarga la pagina);

      // Manda los datos al backend para ser guardados ahi 
      fetch('./backend/postEstatusAvanzarACalidad.php', {
        method: 'POST',
        body: JSON.stringify({
          orderNo: document.getElementById('orden_servicio_contenido').getAttribute("orden_actual"),
        }),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      })
        .then(function (response) {
          return response.text();
        })
        .then(function (return_data) {

          if (return_data === "Registro actualizado") {
            alert("Registro actualizado.");
            window.location.reload();
          } else {
            console.log(return_data);
            alert("Error no se pudo guardar la informacion.");
          }
        })
        .catch(function (err) {
          console.log(err);
        });
    }

    // Inicializar las funciones aqui despues del codigo
    cargarOrdenes();
    inspeccionarMisCookies();
    userInterfaseInit();

    function dropdownclickadmin() {
          document.getElementById("menuadministrador").classList.toggle("show");
        }
        
        window.onclick = function(e) {
          if (!e.target.matches('.dropbtn')) {
          var menuadministrador = document.getElementById("menuadministrador");
            if (menuadministrador.classList.contains('show')) {
              menuadministrador.classList.remove('show');
            }
          }
        }
        function dropdownclickasesor() {
          document.getElementById("menuasesor").classList.toggle("show");
        }
        
        window.onclick = function(e) {
          if (!e.target.matches('.dropbtn')) {
          var menuasesor = document.getElementById("menuasesor");
            if (menuasesor.classList.contains('show')) {
              menuasesor.classList.remove('show');
            }
          }
        }
  </script>
</body>

</html>