<html>

<head>
    <title>Altamotriz</title>
    <link rel="shortcut icon" type="image/x-icon" href="./img/car-service.ico" />
    <link rel="stylesheet" href="./css/mi_hoja_de_estilos.css" type="text/css" />
    <link rel="stylesheet" href="./css/index.css" type="text/css" />
</head>

<body style="background-color: #ecf5fc;">
    <div>
        <div>
            <img src="./img/logo.png" width="250" height="100" alt="" class="centrar" ;>

            <div class="li_menu">
                <ul style="border-radius: 8px;">
                    <li class="li-right"><a href="./menu.html"><img src="./img/cerrar_sesion.ico" alt="Salir"
                                style="width: 25px;height:22px;">&nbsp &nbsp Volver al menu principal</a>
                    </li>
                </ul>
            </div>
        </div>

        <div>
            <div class="fila" style="  margin: auto; width: 40%; padding: 10px;">
                <h1 style="color: 222;">Selecciona el usuario deseado desde la tabla</h1>
                <div id="tabla_usuarios"></div>
            </div>
            <div class="fila" style="  margin: auto; width: 40%; padding: 10px;">
                <h2 style="color: 222;">Agregar un usuario nuevo</h2>
                <div class="fila" style=" margin: auto; width: 40%; padding: 10px;">
                    <button id="btn_creat_user"
                        onclick="document.getElementById('modaladdUsers').style.display='block'">Agregar</button>
                </div>
            </div>
        </div>
        <div>
            <div id="modalVer" class="modal">
                <div class="modal-content animate">
                    <form class="" id="verModalForm">
                        <div class="imgcontainer">
                            <span onclick="document.getElementById('modalVer').style.display='none'" class="close"
                                title="Close Modal">&times;</span>
                        </div>

                        <div class="container">

                            <p>Idempleado:<strong><span id="ver_idempleado"></span></strong></p>
                            <p>Usuario:<strong><span id="ver_usuario"></span></strong></p>
                            <p>Contrasena:<strong><span id="ver_contraseña"></span></strong></p>
                            <p>Nombre:<strong><span id="ver_nombre"></span></strong></p>
                            <p>Apellido:<strong><span id="ver_apellido"></span></strong></p>
                            <p>Puesto:<strong><span id="ver_puesto"></span></strong></p>

                            <label>
                            </label>
                        </div>

                        <div class="container" style="background-color:#f1f1f1">
                            <button type="button" onclick="document.getElementById('modalVer').style.display='none'"
                                class="cancelbtn">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div>
            <div id="id01" class="modal">
                <div class="modal-content" style="width:40%">
                    <form id="editModalForm">
                        <div class="imgcontainer">
                            <span onclick="document.getElementById('id01').style.display='none'" class="close"
                                title="Close Modal">&times;</span>

                        </div>

                        <div class="container">
                            <div class="form-group">
                                <input type="hidden" placeholder="" name="idempleado" id="idempleado" required><br>
                            </div>
                            <div class="form-group">
                                <label><b>Usuario</b></label><br>
                                <input type="text" placeholder="" name="usuario" id="usuario" onkeypress="checkInputOnlyLetters(event)" required><br>
                            </div>
                            <div class="form-group">
                                <label for="contrasena"><b>Contrasena</b></label><br>
                                <input type="password" placeholder="" name="contrasena" id="contrasena" required><br>
                            </div>
                            <div class="form-group">
                                <label><b>Nombre</b></label><br>
                                <input type="text" placeholder="" name="nombre" id="nombre" onkeypress="checkInputOnlyLetters(event)" required>
                            </div>
                            <div class="form-group">
                                <label><b>Apellido</b></label><br>
                                <input type="text" placeholder="" name="apellido" id="apellido" onkeypress="checkInputOnlyLetters(event)" required>
                            </div>
                            <div class="form-group">
                                <label><b>Puesto</b></label><br>
                                <input type="text"  placeholder="" name="puesto" id="puesto" onkeypress="checkInputOnlyLetters(event)" required>
                            </div>
                            <button type="submit">Guardar</button>

                            <div class="container" style="background-color:#f1f1f1">
                                <button type="button" onclick="document.getElementById('id01').style.display='none'"
                                    class="cancelbtn">Cancelar</button>
                            </div>
                    </form>
                </div>
            </div>
        </div>
        <div>
            <div id="modaladdUsers" class="modal">
                <div class="modal-content" style="width:40%">
                    <form id="addModalForm">
                        <div class="imgcontainer">
                            <span onclick="document.getElementById('modaladdUsers').style.display='none'" class="close"
                                title="Close Modal">&times;</span>

                        </div>

                        <div class="container">
                            <div class="form-group">
                                <input type="hidden" placeholder="" name="add_idempleado" id="add_idempleado"
                                    required><br>
                            </div>
                            <div class="form-group">
                                <label><b>Usuario</b></label><br>
                                <input type="text" placeholder="" name="add_usuario" id="add_usuario" onkeypress="checkInputOnlyLetters(event)" required><br>
                            </div>
                            <div class="form-group">
                                <label for="contrasena"><b>Contrasena</b></label><br>
                                <input type="password" placeholder="" name="add_contrasena" id="add_contrasena"
                                    required><br>
                            </div>
                            <div class="form-group">
                                <label><b>Nombre</b></label><br>
                                <input type="text" placeholder="" name="add_nombre" id="add_nombre" onkeypress="checkInputOnlyLetters(event)" required>
                            </div>
                            <div class="form-group">
                                <label><b>Apellido</b></label><br>
                                <input type="text" placeholder="" name="add_apellido" id="add_apellido" onkeypress="checkInputOnlyLetters(event)" required>
                            </div>
                            <div class="form-group">
                                <label><b>Puesto</b></label><br>
                                <input type="text"  placeholder="" name="add_puesto" id="add_puesto" onkeypress="checkInputOnlyLetters(event)" required>
                            </div>
                            <button type="submit">Guardar</button>

                            <div class="container" style="background-color:#f1f1f1">
                                <button type="button"
                                    onclick="document.getElementById('modaladdUsers').style.display='none'"
                                    class="cancelbtn">Cancelar</button>
                            </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function cargarTodos() {

            fetch('./backend/administrador/getUsers.php', {
                method: 'GET',
            })
                .then(function (response) {
                    return response.text();
                })
                .then(function (return_data) {
                    if (return_data == "no hay Usuarios") {
                        alert("no hay Usuarios");
                        return;
                    }

                    console.log(return_data);

                    var data = JSON.parse(return_data);

                    var columnNames = [
                        "idempleado",
                        "usuario",
                        "contrasena",
                        "nombre",
                        "apellido",
                        "puesto",
                        "opciones"
                    ];

                    var table = document.createElement('table');

                    // Titulos solamente
                    var tr = document.createElement('tr');

                    var td = document.createElement('td');
                    var text = document.createTextNode('Id');
                    td.appendChild(text);
                    tr.appendChild(td);
                    var td = document.createElement('td');
                    var text = document.createTextNode('Ususario');
                    td.appendChild(text);
                    tr.appendChild(td);
                    var td = document.createElement('td');
                    var text = document.createTextNode('Contrasena');
                    td.appendChild(text);
                    tr.appendChild(td);
                    td = document.createElement('td');
                    text = document.createTextNode('Nombre');
                    td.appendChild(text);
                    tr.appendChild(td);
                    td = document.createElement('td');
                    text = document.createTextNode('Apellido');
                    td.appendChild(text);
                    tr.appendChild(td);
                    td = document.createElement('td');
                    text = document.createTextNode('Puesto');
                    td.appendChild(text);
                    tr.appendChild(td);
                    td = document.createElement('td');
                    text = document.createTextNode('Opciones');
                    td.appendChild(text);
                    tr.appendChild(td);
                    table.appendChild(tr);


                    // Lenado de la tabla 
                    for (var i = 0; i < data.length; i++) {
                        var tr = document.createElement('tr');

                        for (var j = 0; j < columnNames.length; j++) {
                            var td = document.createElement('td');

                            if (columnNames[j] === 'opciones') {

                                var btn = document.createElement('input');
                                btn.type = "button";
                                btn.className = "btnEdit";
                                btn.value = "Editar";
                                btn.name = data[i]['idempleado'];

                                tr.appendChild(btn);

                                var btn = document.createElement('input');
                                btn.type = "button";
                                btn.className = "btnVer";
                                btn.value = "Ver";
                                btn.name = data[i]['idempleado'];

                                tr.appendChild(btn);

                                var btn = document.createElement('input');
                                btn.type = "button";
                                btn.className = "btnBorrar";
                                btn.value = "Borrar";
                                btn.name = data[i]['idempleado'];

                                tr.appendChild(btn);
                            }
                            else {
                                var text = document.createTextNode(data[i][columnNames[j]]);

                                td.appendChild(text);
                                tr.appendChild(td);
                            }
                        }

                        table.appendChild(tr);
                    }


                    document.getElementById("tabla_usuarios").appendChild(table);


                    const editBtns = document.getElementsByClassName('btnEdit');

                    for (const btnEdit of editBtns) {
                        btnEdit.addEventListener("click", e => {
                            console.log("ver Id:", e.target.name);
                            editById(e.target.name);
                        })
                    }

                    const verBtns = document.getElementsByClassName('btnVer');

                    for (const btnVer of verBtns) {
                        btnVer.addEventListener("click", e => {
                            console.log("ver Id: ", e.target.name);
                            verById(e.target.name);
                        })
                    }

                    const borrarBtns = document.getElementsByClassName('btnBorrar');

                    for (const btnBorrar of borrarBtns) {
                        btnBorrar.addEventListener("click", e => {
                            console.log("ver  Id: ", e.target.name);
                            deleteById(e.target.name);
                        })
                    }


                })
                .catch(function (err) {
                    console.log(err);
                });



        }


        function editById(id) {

            document.getElementById('id01').style.display = 'block';

            fetch('./backend/administrador/getUsersById.php', {
                method: 'POST',
                body: JSON.stringify({
                    id: id,
                }),
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
                .then(function (response) {
                    return response.text();
                })
                .then(function (respuesta) {

                    respuesta = JSON.parse(respuesta);

                    document.getElementById("idempleado").value = respuesta[0]['idempleado'];
                    document.getElementById("usuario").value = respuesta[0]['usuario'];
                    document.getElementById("contrasena").value = respuesta[0]['contrasena'];
                    document.getElementById("nombre").value = respuesta[0]['nombre'];
                    document.getElementById("apellido").value = respuesta[0]['apellido'];
                    document.getElementById("puesto").value = respuesta[0]['puesto'];

                });
        }

        var form = document.getElementById("editModalForm");
        form.addEventListener('submit', handleEditForm);

        function handleEditForm(event) {
            event.preventDefault();
            let editModalForm = new FormData(document.getElementById("editModalForm"));

            fetch('./backend/administrador/updateUserById.php', {
                method: 'POST',
                body: editModalForm
            })
                .then(function (response) {
                    return response.text();
                })
                .then(function (respuesta) {
                    console.log(respuesta);
                    if (respuesta === 'Registro actualizado') {
                        alert("Registro actualizado");
                        window.location.reload();
                    } else {
                        alert("Error al actualizar el registro");
                    }
                });
        }

        function userInterfaseInit() {

            function redireccionCliente() {
                location.replace("./index.html");
            }

            //referenciar el modal
            var modal = document.getElementById('id01');
            var modaladd = document.getElementById('modaladdUsers');

            // se cierra si se hace click fuera de la ventana
            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
            window.onclick = function (event) {
                if (event.target == modaladd) {
                    modaladd.style.display = "none";
                }
            }
        }

        function verById(id) {

            document.getElementById('modalVer').style.display = 'block';

            fetch('./backend/administrador/getUsersById.php', {
                method: 'POST',
                body: JSON.stringify({
                    id: id,
                }),
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })

                .then(function (response) {
                    return response.text();

                })
                .then(function (respuesta) {
                    respuesta = JSON.parse(respuesta);
                    console.log(respuesta);


                    document.getElementById("ver_idempleado").innerHTML = respuesta[0]['idempleado'];
                    document.getElementById("ver_usuario").innerHTML = respuesta[0]['usuario'];
                    document.getElementById("ver_contraseña").innerHTML = respuesta[0]['contraseña'];
                    document.getElementById("ver_nombre").innerHTML = respuesta[0]['nombre'];
                    document.getElementById("ver_apellido").innerHTML = respuesta[0]['apellido'];
                    document.getElementById("ver_puesto").innerHTML = respuesta[0]['puesto'];

                });
        }
        function deleteById(id) {
            fetch('./backend/administrador/deleteUsersById.php', {
                method: 'POST',
                body: JSON.stringify({
                    id: id,
                }),
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
                .then(function (response) {
                    return response.text();
                })
                .then(function (respuesta) {
                    console.log(respuesta);
                    if (respuesta === "Registro eliminado") {

                        window.location.reload();

                    } else {
                        alert("se elimino el registro");
                    }
                }
                );
        }





        var form = document.getElementById("addModalForm");
        form.addEventListener('submit', handleAddForm);

        function handleAddForm(event) {
            event.preventDefault();

            let addModalForm = new FormData(document.getElementById("addModalForm"));

            fetch('./backend/administrador/addUsers.php', {
                method: 'POST',
                body: addModalForm
            })
                .then(function (response) {
                    return response.text();
                })
                .then(function (return_data) {
                    console.log(return_data);

                    if (return_data === 'Registro insertado') {
                        alert("Registro insertado");
                        document.location.reload();
                    } else {
                        alert("Error al insertar");
                    }
                })
                .catch(function (err) {
                    console.log(err);
                });
        }
        function checkInputOnlyLetters(e)
{
    //only alpha-numeric characters
    var ok = /[A-Za-z]/.test(String.fromCharCode(e.charCode));
    if (!ok)
        e.preventDefault();
}
function checkInputOnlyLettersAndNumbers(e)
{
    //only alpha-numeric characters
    var ok = /[A-Za-z0-9]/.test(String.fromCharCode(e.charCode));
    if (!ok)
        e.preventDefault();
}

        userInterfaseInit();
        cargarTodos();
    </script>
</body>

</html>